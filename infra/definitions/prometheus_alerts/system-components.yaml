apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    app: kube-prometheus-stack
    app.kubernetes.io/instance: kube-prometheus-stack
    app.kubernetes.io/part-of: kube-prometheus-stack
    release: kube-prometheus-stack
  name: kube-prometheus-stack-system-components.rules
  namespace: kube-prometheus-stack
spec:
  groups:
    - name: system-components.rules
      rules:
        - alert: SystemDeploymentNotReady
          annotations:
            description: System deployments (not in the ws- namespace) is not ready for 10 mins
            summary: System deployments (not in the ws- namespace) is not ready for 10 mins
          expr: |-
            kube_deployment_status_condition{deployment!~".*headroom.*", namespace!~"ws-.+", status=~"false|unknown"} > 0
          for: 10m
          labels:
            severity: critical
        - alert: HeadroomDeploymentNotReady
          annotations:
            description: Headroom deployments (not in the ws- namespace) is not ready for 15 mins
            summary: Headroom deployments (not in the ws- namespace) is not ready for 15 mins
          expr: |-
            kube_deployment_status_condition{deployment=~".*headroom.*", namespace="kube-system", status=~"false|unknown"} > 0
          for: 15m
          labels:
            severity: critical
        - alert: SystemPodsNotReady
          annotations:
            description: System pods (not in the ws- namespace) not running for 5 min
            summary: System pods (not in the ws- namespace) not running for 5 min
          expr: |-
            kube_pod_status_phase{pod!~".*headroom.*", namespace!~"ws-.+", phase=~"Pending|Unknown"} > 0
          for: 5m
          labels:
            severity: critical
        - alert: HeadroomPodsNotReady
          annotations:
            description: Headroom pods (not in the ws- namespace) not running for 15 min
            summary: Headroom pods (not in the ws- namespace) not running for 15 min
          expr: |-
            kube_pod_status_phase{pod=~".*headroom.*", namespace="kube-system", phase=~"Pending|Unknown"} > 0
          for: 15m
          labels:
            severity: critical
        - alert: SystemPodFailed
          annotations:
            description: System pods (pods not in the ws- namespace) failed
            summary: System pods (pods not in the ws- namespace) failed
          expr: |-
            kube_pod_status_phase{namespace!~"ws-.+", phase="Failed"} > 0
          for: 1m
          labels:
            severity: critical
        - alert: PVReleased
          annotations:
            description: PV is released/unbound for more than 5 min
            summary: Number of released/unbound PV is elevated
          expr: |-
            kube_persistentvolume_status_phase{phase=~"Released|Available|Failed"} > 0
          for: 5m
          labels:
            severity: critical
        - alert: PVPending
          annotations:
            description: PV is pending for more than 5 min
            summary: PV is pending for more than 5 min
          expr: |-
            kube_persistentvolume_status_phase{phase=~"Pending"} > 0
          for: 5m
          labels:
            severity: critical
        - alert: NodeFilesystemAlmostFull
          annotations:
            description: Node filesystem is almost full
            summary: Node filesystem is almost full
          expr: |-
            node_filesystem_avail_bytes / node_filesystem_size_bytes < 0.2
          for: 1m
          labels:
            severity: critical
        - alert: SystemComponentCPUUsageHigh
          annotations:
            description: System component CPU usage at {{ $value }}% (> 50%) for 5 minute.
            summary: System component CPU usage high
          expr: |-
            max(rate(container_cpu_usage_seconds_total{namespace!~"ws-.+"}[1m])) by (namespace, pod, container)
            / max(kube_pod_container_resource_limits{resource="cpu"}) by (namespace, pod, container)
            * 100 > 50
          for: 5m
          labels:
            severity: critical
        - alert: SystemComponentMemoryUsageHigh
          annotations:
            description: System component memory usage at {{ $value }}% (> 80%) for 5 minute.
            summary: System component memory usage high
          expr: |-
            max(container_memory_usage_bytes{namespace!~"ws-.+"}) by (namespace, pod, container)
            / max(kube_pod_container_resource_limits{resource="memory"}) by (namespace, pod, container)
            * 100 > 80
          for: 5m
          labels:
            severity: critical
